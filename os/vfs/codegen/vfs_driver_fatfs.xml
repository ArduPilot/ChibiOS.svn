<?xml version="1.0" encoding="UTF-8"?>
<!-- C module definition -->
<module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="http://www.chibios.org/xml/schema/ccode/modules.xsd"
  name="drvfatfs_test" descr="VFS FatFS Driver"
  check="VFS_CFG_ENABLE_DRV_FATFS == TRUE" sourcepath="drivers/fatfs"
  headerpath="drivers/fatfs">
  <public>
    <inclusions>
      <include style="regular">oop_sequential_stream.h</include>
    </inclusions>
    <configs>
      <config name="DRV_CFG_FATFS_FS_NUM" default="1">
        <brief>Maximum number of FatFS file systems mounted.</brief>
        <assert invalid="$N &lt; 1" />
      </config>
      <config name="DRV_CFG_FATFS_DIR_NODES_NUM" default="1">
        <brief>Number of directory nodes pre-allocated in the pool.</brief>
        <assert invalid="$N &lt; 1" />
      </config>
      <config name="DRV_CFG_FATFS_FILE_NODES_NUM" default="1">
        <brief>Number of file nodes pre-allocated in the pool.</brief>
        <assert invalid="$N &lt; 1" />
      </config>
    </configs>
    <types>
      <class type="regular" name="vfs_fatfs_dir_node" namespace="ffdir"
        ancestorname="vfs_directory_node" ancestornamespace="vfsdir"
        descr="VFS fatfs directory node">
        <fields>
          <field name="dir" ctype="DIR">
            <brief>FatFS inner @p DIR structure.</brief>
          </field>
        </fields>
        <methods>
          <objinit>
            <implementation><![CDATA[]]></implementation>
          </objinit>
          <dispose>
            <implementation><![CDATA[]]></implementation>
          </dispose>
        </methods>
      </class>
      <class type="regular" name="vfs_fatfs_file_node" namespace="fffile"
        ancestorname="vfs_file_node" ancestornamespace="vfsfile"
        descr="VFS fatfs file node">
        <implements>
          <ifref name="sequential_stream" namespace="stm" />
        </implements>
        <fields>
          <field name="stm" ctype="sequential_stream_i">
            <brief>Stream interface for this file.</brief>
          </field>
          <field name="file" ctype="FIL">
            <brief>FatFS inner @p FIL structure.</brief>
          </field>
        </fields>
        <methods>
          <objinit>
            <implementation><![CDATA[]]></implementation>
          </objinit>
          <dispose>
            <implementation><![CDATA[]]></implementation>
          </dispose>
        </methods>
      </class>
      <class type="regular" name="vfs_fatfs_driver" namespace="ffdrv"
        ancestorname="vfs_driver" ancestornamespace="vfsdrv"
        descr="VFS fatfs driver">
        <fields></fields>
        <methods>
          <objinit>
            <implementation><![CDATA[]]></implementation>
          </objinit>
          <dispose>
            <implementation><![CDATA[]]></implementation>
          </dispose>
        </methods>
      </class>
      <struct name="vfs_fatfs_driver_static_struct">
        <brief>Global state of @p vfs_fatfs_driver_c.</brief>
        <fields>
          <field name="fs_nodes_pool" ctype="memory_pool_t">
            <brief>Pool of file system objects.</brief>
          </field>
          <field name="info_nodes_pool" ctype="memory_pool_t">
            <brief>Pool of file info objects.</brief>
          </field>
          <field name="dir_nodes_pool" ctype="memory_pool_t">
            <brief>Pool of file directory nodes.</brief>
          </field>
          <field name="file_nodes_pool" ctype="memory_pool_t">
            <brief>Pool of file nodes.</brief>
          </field>
          <field name="dir_nodes"
            ctype="vfs_fatfs_dir_node_c$I$N[DRV_CFG_FATFS_DIR_NODES_NUM]">
            <brief>Pool of file nodes.</brief>
          </field>
          <field name="file_nodes"
            ctype="vfs_fatfs_file_node_c$I$N[DRV_CFG_FATFS_DIR_NODES_NUM]">
            <brief>Pool of file nodes.</brief>
          </field>
        </fields>
      </struct>
      <struct name="vfs_fatfs_driver_static_nc_struct">
        <brief>Global state of @p vfs_fatfs_driver_c (non-cached part).</brief>
        <fields>
          <field name="fs" ctype="FATFS$I$N[DRV_CFG_FATFS_FS_NUM]">
            <brief>Pool of file system objects.</brief>
          </field>
        </fields>
      </struct>
    </types>
    <variables>
      <variable name="vfs_fatfs_driver_static"
        ctype="struct vfs_fatfs_driver_static_struct">
        <brief>Global state of @p vfs_fatfs_driver_c</brief>
      </variable>
      <variable name="__nocache_vfs_fatfs_driver_static"
        ctype="struct vfs_fatfs_driver_static_nc_struct">
        <brief>Global state of @p vfs_fatfs_driver_c</brief>
      </variable>
    </variables>
    <functions>
      <function name="__drv_fatfs_init" ctype="void">
        <brief>Module initialization.</brief>
        <init />
        <implementation><![CDATA[

/* Initializing pools.*/
chPoolObjectInit(&vfs_fatfs_driver_static.dir_nodes_pool,
                 sizeof (vfs_fatfs_dir_node_c),
                 chCoreAllocAlignedI);
chPoolObjectInit(&vfs_fatfs_driver_static.file_nodes_pool,
                 sizeof (vfs_fatfs_file_node_c),
                 chCoreAllocAlignedI);

/* Preloading pools.*/
chPoolLoadArray(&vfs_fatfs_driver_static.dir_nodes_pool,
                &vfs_fatfs_driver_static.dir_nodes[0],
                DRV_CFG_FATFS_DIR_NODES_NUM);
chPoolLoadArray(&vfs_fatfs_driver_static.file_nodes_pool,
                &vfs_fatfs_driver_static.file_nodes[0],
                DRV_CFG_FATFS_FILE_NODES_NUM);]]></implementation>
      </function>
      <function>
        <brief>Mounts a FatFS volume.</brief>
        <param name="name" ctype="const char *" dir="in"><![CDATA[Name to
                be assigned to the volume, see FatFS @p f_mount() documentation
                because there are several options.]]></param>
        <param name="mountnow" ctype="bool" dir="in">Immediate mount option.
        </param>
        <return>The operation result.</return>
        <api />
        <implementation><![CDATA[
FATFS *fs;
FRESULT res;

fs = f_getfs(name);
if (fs == NULL) {
  fs = chPoolAlloc(&vfs_fatfs_driver_static.fs_nodes_pool);
  if (fs == NULL) {
    return CH_RET_ENOMEM;
  }
}

res = f_mount(fs, name, (BYTE)(mountnow ? 1 : 0));
if (res != FR_OK) {
  chPoolFree(&vfs_fatfs_driver_static.fs_nodes_pool, (void *)fs);
}

return translate_error(res);]]></implementation>
      </function>
      <function>
        <brief>Unmounts a FatFS volume.</brief>
        <param name="name" ctype="const char *" dir="in">Name of the volume to be unmounted.</param>
        <return>The operation result.</return>
        <api />
        <implementation><![CDATA[
FATFS *fs;
FRESULT res;

fs = f_getfs(name);
if (fs == NULL) {
  return CH_RET_EINVAL;
}

res = f_unmount(name);

chPoolFree(&vfs_fatfs_driver_static.fs_nodes_pool, (void *)fs);

return translate_error(res);]]></implementation>
      </function>
    </functions>
  </public>
  <private>
    <inclusions>
      <include style="regular">vfs.h</include>
      <include style="regular">drvfatfs_impl.h</include>
    </inclusions>
    <functions>
      <function name="__ffdir_ro_addref_impl" ctype="void *">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __ro_addref_impl(ip);]]></implementation>
      </function>
      <function name="__ffdir_ro_release_impl"
        ctype="object_references_t">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __ro_release_impl(ip);]]></implementation>
      </function>
      <function name="__ffdir_vfsnode_stat_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="sp" ctype="vfs_stat_t *" />
        <implementation><![CDATA[

return __vfsnode_stat_impl(ip, sp);]]></implementation>
      </function>
      <function name="__ffdir_vfsdir_first_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="dip" ctype="vfs_direntry_info_t *" />
        <implementation><![CDATA[

return __vfsdir_first_impl(ip, dip);]]></implementation>
      </function>
      <function name="__ffdir_vfsdir_next_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="dip" ctype="vfs_direntry_info_t *" />
        <implementation><![CDATA[

return __vfsdir_next_impl(ip, dip);]]></implementation>
      </function>
      <function name="__fffile_ro_addref_impl" ctype="void *">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __ro_addref_impl(ip);]]></implementation>
      </function>
      <function name="__fffile_ro_release_impl"
        ctype="object_references_t">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __ro_release_impl(ip);]]></implementation>
      </function>
      <function name="__fffile_vfsnode_stat_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="sp" ctype="vfs_stat_t *" />
        <implementation><![CDATA[

return __vfsnode_stat_impl(ip, sp);]]></implementation>
      </function>
      <function name="__fffile_vfsfile_read_impl" ctype="ssize_t">
        <param name="ip" ctype="void *" />
        <param name="buf" ctype="uint8_t *" />
        <param name="size" ctype="size_t" />
        <implementation><![CDATA[

return __vfsfile_read_impl(ip, buf, size);]]></implementation>
      </function>
      <function name="__fffile_vfsfile_write_impl" ctype="ssize_t">
        <param name="ip" ctype="void *" />
        <param name="buf" ctype="const uint8_t *" />
        <param name="size" ctype="size_t" />
        <implementation><![CDATA[

return __vfsfile_write_impl(ip, buf, size);]]></implementation>
      </function>
      <function name="__fffile_vfsfile_setpos_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="offset" ctype="vfs_offset_t" />
        <param name="whence" ctype="vfs_seekmode_t" />
        <implementation><![CDATA[

return __vfsfile_setpos_impl(ip, offset, whence);]]></implementation>
      </function>
      <function name="__fffile_vfsfile_getpos_impl"
        ctype="vfs_offset_t">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __vfsfile_getpos_impl(ip);]]></implementation>
      </function>
      <function name="__fffile_vfsfile_getstream_impl"
        ctype="BaseSequentialStream *">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[

return __vfsfile_getstream_impl(ip);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_setcwd_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <implementation><![CDATA[

return __vfsdrv_setcwd_impl(ip, path);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_getcwd_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="buf" ctype="char *" />
        <param name="size" ctype="size_t" />
        <implementation><![CDATA[

return __vfsdrv_getcwd_impl(ip, buf, size);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_stat_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <param name="sp" ctype="vfs_stat_t *" />
        <implementation><![CDATA[

return __vfsdrv_stat_impl(ip, path, sp);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_opendir_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <param name="vdnpp" ctype="vfs_directory_node_c **" />
        <implementation><![CDATA[

return __vfsdrv_opendir_impl(ip, path, vdnpp);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_openfile_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <param name="flags" ctype="int" />
        <param name="vfnpp" ctype="vfs_file_node_c **" />
        <implementation><![CDATA[

return __vfsdrv_openfile_impl(ip, path, flags, vfnpp);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_unlink_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <implementation><![CDATA[

return __vfsdrv_unlink_impl(ip, path);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_rename_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="oldpath" ctype="const char *" />
        <param name="newpath" ctype="const char *" />
        <implementation><![CDATA[

return __vfsdrv_rename_impl(ip, oldpath, newpath);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_mkdir_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <param name="mode" ctype="vfs_mode_t" />
        <implementation><![CDATA[

return __vfsdrv_mkdir_impl(ip, path, mode);]]></implementation>
      </function>
      <function name="__ffdrv_vfsdrv_rmdir_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="path" ctype="const char *" />
        <implementation><![CDATA[

return __vfsdrv_rmdir_impl(ip, path);]]></implementation>
      </function>
      <function name="__fffile_stm_write_impl" ctype="size_t">
        <param name="ip" ctype="void *" />
        <param name="buf" ctype="const uint8_t *" />
        <param name="size" ctype="size_t" />
        <implementation><![CDATA[
vfs_fatfs_file_node_c *self = oopIfGetOwner(vfs_fatfs_file_node_c, ip);

(void)self;
(void)buf;
(void)size;

return (size_t)0;]]></implementation>
      </function>
      <function name="__fffile_stm_read_impl" ctype="size_t">
        <param name="ip" ctype="void *" />
        <param name="buf" ctype="uint8_t *" />
        <param name="size" ctype="size_t" />
        <implementation><![CDATA[
vfs_fatfs_file_node_c *self = oopIfGetOwner(vfs_fatfs_file_node_c, ip);

(void)self;
(void)buf;
(void)size;

return (size_t)0;]]></implementation>
      </function>
      <function name="__fffile_stm_put_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <param name="b" ctype="uint8_t" />
        <implementation><![CDATA[
vfs_fatfs_file_node_c *self = oopIfGetOwner(vfs_fatfs_file_node_c, ip);

(void)self;
(void)b;

return MSG_OK;]]></implementation>
      </function>
      <function name="__fffile_stm_get_impl" ctype="msg_t">
        <param name="ip" ctype="void *" />
        <implementation><![CDATA[
vfs_fatfs_file_node_c *self = oopIfGetOwner(vfs_fatfs_file_node_c, ip);

(void)self;

return (msg_t)0;]]></implementation>
      </function>
    </functions>
  </private>
</module>